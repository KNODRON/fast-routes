<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Unidades de Carabineros</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .leaflet-control-zoom {
      bottom: 80px !important;
      top: auto !important;
      left: 10px !important;
      right: auto !important;
    }
    #buscador {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      width: 90%;
      max-width: 400px;
    }
    #buscador input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="buscador">
    <input type="text" id="inputBusqueda" placeholder="Buscar unidad..." />
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-33.4489, -70.6693], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let markers = [];

    async function cargarUnidades() {
      const response = await fetch("https://knodron.github.io/fast-routes/unidades_carabineros.json");
      const unidades = await response.json();

      unidades.forEach(unidad => {
        const [lat, lng] = unidad.coords.split(",").map(c => parseFloat(c.trim()));
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`<strong>${unidad.nombre}</strong><br>${unidad.prefectura || ''}`);
        markers.push({ marker, nombre: unidad.nombre.toLowerCase() });

        if (unidad.subunidades) {
          unidad.subunidades.forEach(sub => {
            const [sLat, sLng] = sub.coords.split(",").map(c => parseFloat(c.trim()));
            const subMarker = L.circleMarker([sLat, sLng], {
              radius: 6,
              color: "green",
              fillColor: "#3f0",
              fillOpacity: 0.9
            }).addTo(map);
            subMarker.bindPopup(`<strong>${sub.nombre}</strong><br>Depende de: ${unidad.nombre}`);
            markers.push({ marker: subMarker, nombre: sub.nombre.toLowerCase() });
          });
        }
      });
    }

    cargarUnidades();

    const inputBusqueda = document.getElementById("inputBusqueda");
    inputBusqueda.addEventListener("input", () => {
      const texto = inputBusqueda.value.toLowerCase();
      markers.forEach(({ marker, nombre }) => {
        if (nombre.includes(texto)) {
          marker.setStyle?.({ opacity: 1, fillOpacity: 0.9 }) || marker.setOpacity(1);
          marker.openPopup();
        } else {
          marker.setStyle?.({ opacity: 0.1, fillOpacity: 0.1 }) || marker.setOpacity(0.1);
        }
      });

      if (!texto) {
        markers.forEach(({ marker }) => {
          marker.setStyle?.({ opacity: 1, fillOpacity: 0.9 }) || marker.setOpacity(1);
        });
      }
    });
  </script>
</body>
</html>
